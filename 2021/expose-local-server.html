













<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>💻【环境搭建】服务器内网穿透 [ 隐秀 ]</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-one-light.min.css">
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
  

  <link rel="stylesheet" href="/css/third_party/utilities.min.css">
  <link rel="stylesheet" href="/css/star.css">
<meta name="generator" content="Hexo 6.1.0"></head>
<body>

<main class="page-content" aria-label="Content">
  

  <div class="wrapper">
    
    
  <article 
    class="post h-entry"
    id="post"
    itemscope
    itemtype="http://schema.org/BlogPosting"
  >

  <header class="post-header">
    <div class="post-back">
      <a class="black-link" href="/">
        ← Home
      </a>
    </div>

    <h1 class="post-title p-name" itemprop="name headline">
      💻【环境搭建】服务器内网穿透
    </h1>
    <p class="post-meta">
      <time
        class="dt-published"
        datetime="1613281249000"
        itemprop="datePublished"
      >
        Feb 14, 2021
      </time>•
      <span itemprop="author" itemscope itemtype="http://schema.org/Person"
        ><span class="p-author h-card" itemprop="name"
          >seriouszyx</span
        ></span
      >
        <span class="busuanzi_container_page">
          <span id="busuanzi_container_page_pv">
            •
          <span id="busuanzi_value_page_pv"></span> View
          </span>
        </span>
      
    </p>
  </header>

  <div class="js-toc"></div>

  <div class="post-content" itemprop="articleBody">
    <p>本科 AI 实验室的服务器在内网部署，疫情期间大家都没办法在学校，又需要使用 GPU 完成一些工作。正好老板又添置了一台服务器，派我做一下内网穿透，方便远程使用。</p>
<h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><p>主要想记录一下软件方面的配置，所以怎么安装滑轨、怎么接线这类问题就不赘述了，下面的表格中记录了两台服务器的软硬件配置。</p>
<table>
<thead>
<tr>
<th></th>
<th>server1</th>
<th>server2</th>
</tr>
</thead>
<tbody><tr>
<td>GPU</td>
<td>Tesla V100 16G×2</td>
<td>Quadro RTX 6000 24G×2</td>
</tr>
<tr>
<td>CPU</td>
<td>Intel Xeon Gold 5117 @ 2.00GHz</td>
<td>Intel Xeon Gold 6240R @ 2.40GHz</td>
</tr>
<tr>
<td> 内存</td>
<td> 128G</td>
<td>128G</td>
</tr>
<tr>
<td> 硬盘</td>
<td> 20TB</td>
<td>24TB</td>
</tr>
<tr>
<td> 操作系统</td>
<td> Ubuntu 18.04 LTS</td>
<td>Ubuntu 18.04 LTS</td>
</tr>
</tbody></table>
<h2 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h2><p>上述两台服务器都在学院机房里，此局域网的限制很大，甚至学校提供的 VPN 都无法访问，必须要在学院内部的网络才能访问。当用户在宿舍或者校外，是没有官方提供的代理工具来连接服务器的，所以就需要一台公网服务器做转发，用户通过公网 ip 来访问内网的服务器，这就需要内网穿透技术。</p>
<p>市面上有一些成熟的内网穿透软件，如花生壳、蒲公英等，但免费版本大多有带宽限制，且速度极慢，无法正常使用。然而这些软件底层或多或少都依赖 <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a>，一款专注于内网穿透的高性能反向代理应用，支持多种协议，可以安全的将内网服务通过公网 ip 节点的中转暴露到公网。</p>
<p>经调研后发现，frp 原生支持端口复用，也就是多个服务通过同一个服务端端口暴露。这样可以使用一台公网服务器同时代理两台内网服务，通过不同外网端口访问不同的内网服务。</p>
<p>frp 的安装包在 <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">GitHub </a>上，值得注意的是，要想使 frp 正常工作，必须在不同服务器上下载相同版本的 frp 包。</p>
<h3 id="服务端设置"><a href="#服务端设置" class="headerlink" title="服务端设置"></a>服务端设置</h3><blockquote>
<p>frp 的服务端是进行中转的公网服务器，具有独立的公网 ip。</p>
</blockquote>
<p>下载解压 frp 包，我一般放置在 <code>/usr/local/frp/</code> 目录下，编辑服务端配置文件 <code>frps.ini</code> 。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
bind_port <span class="token operator">=</span> <span class="token number">7000</span>
vhost_http_port <span class="token operator">=</span> <span class="token number">8899</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>其中：</p>
<ul>
<li>“bind_port” 表示用于客户端和服务端连接的端口，这个端口号我们之后在配置客户端的时候要用到。</li>
<li>“vhost_http_port” 和 “vhost_https_port” 用于反向代理 HTTP 主机时使用，本文不涉及 HTTP 协议，因而照抄或者删除这条均可。</li>
</ul>
<p>编辑完成后即可保存，运行服务端应用。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./frps -c frps.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>此时的服务端仅运行在前台，如果 <code>Ctrl+C</code> 停止或者关闭 SSH 窗口后，frps 均会停止运行，因而我们使用 <a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-comm-nohup.html">nohup 命令</a>将其运行在后台。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> ./frps -c frps.ini <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>至此，服务端即设置完成，你可以关闭 SSH 窗口了。</p>
<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><blockquote>
<p>frp 的客户端是真正想要访问的内网服务器。</p>
</blockquote>
<p>同样下载解压好 frp 软件，注意版本的统一，编辑两台客户端配置文件 <code>frpc.ini</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
server_addr <span class="token operator">=</span> <span class="token number">39.106</span>.21.214
server_port <span class="token operator">=</span> <span class="token number">7000</span>
 
<span class="token punctuation">[</span>ssh<span class="token punctuation">]</span>
<span class="token builtin class-name">type</span> <span class="token operator">=</span> tcp
local_ip <span class="token operator">=</span> <span class="token number">172.10</span>.1.185
local_port <span class="token operator">=</span> <span class="token number">22</span>
remote_port <span class="token operator">=</span> <span class="token number">6666</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
server_addr <span class="token operator">=</span> <span class="token number">39.106</span>.21.214
server_port <span class="token operator">=</span> <span class="token number">7000</span>

<span class="token punctuation">[</span>ssh1<span class="token punctuation">]</span>
<span class="token builtin class-name">type</span> <span class="token operator">=</span> tcp
local_ip <span class="token operator">=</span> <span class="token number">172.10</span>.1.184
local_port <span class="token operator">=</span> <span class="token number">22</span>
remote_port <span class="token operator">=</span> <span class="token number">6667</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>其中：</p>
<ul>
<li>“server_addr” 为服务端 ip 地址，填入即可。</li>
<li>“server_port” 为服务器端口，填入你设置的端口号即可，如果未改变就是 7000。</li>
<li>“[xxx]” 表示一个规则名称，自己定义，便于查询即可。</li>
<li>“type” 表示转发的协议类型，有 TCP 和 UDP 等选项可以选择，如有需要请自行查询 frp 手册。</li>
<li>“local_port” 是本地应用的端口号，按照实际应用工作在本机的端口号填写即可。</li>
<li>“remote_port” 是该条规则在服务端开放的端口号，自己填写并记录即可。</li>
</ul>
<p>配置好后可以使用同样的方法后台运行客户端程序。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> ./frpc -c frpc.ini <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h2 id="服务链架构"><a href="#服务链架构" class="headerlink" title="服务链架构"></a>服务链架构</h2><p>下面是整个 frp 服务链的架构（图中 ip 及端口号皆为模拟值）：</p>
<p><img src="/assets/posts/expose-local-server/image.png" alt="frp 架构"></p>
<p>实线代表直接网络连接，虚线代表虚拟网络连接。在内网服务器（frpc）中配置的 <code>remote_port</code> 将在启动后向公网服务器（frps）发送（通过 7000 端口）注册信息，发送成功后，公网服务器开始监听 6666 和 6667 两个端口。</p>
<p>在实际访问时，直接在 SSH 客户端输入公网服务器的 ip 地址，通过 6666 和 6667 两个端口号控制访问两台内网服务器，而其中的 <code>server_port</code> 、 <code>server_addr</code> 、 <code>local_ip</code> 和 <code>local_port</code> 等信息对用户透明，简单方便。</p>
<blockquote>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sspai.com/post/52523">使用 frp 进行内网穿透</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/issues/174">frp issues 174</a></li>
</ul>
</blockquote>

  </div>
  </article>

  <div id="paginator">
    
  </div>

  <div id="gitalk-container"></div>

  </div>

</main>

<footer class="site-footer h-card">
  
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name"><a class="black-link" href="/">
                seriouszyx 
              </a></li></ul>
      </div>
    </div>
  </div>
  
    <div class="text-center">
      
        <span class="text-gray-300 text-sm" id="busuanzi_container_site_pv">
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
      
      
        <span class="text-gray-300 text-sm">•</span>
      
      
          <span class="text-gray-300 text-sm" id="busuanzi_container_site_uv">
            本站访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
      
    </div>
  
  
    <div class="text-center">
      <a class="text-gray-300 text-sm" target="_blank" rel="noopener" href="https://beian.miit.gov.cn">辽ICP备19014015号</a>
    </div>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


  <script async src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js">
</script>


  <script src="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-md5@latest/src/md5.min.js"></script>
  <script>
    var gitalk = new Gitalk({
      clientID: '44642f49cf7294147771',
      clientSecret: '0fd99e38c9c741ef79230463f1acf1bba20bb527',
      repo: 'seriouszyx.github.io',
      owner: 'seriouszyx',
      admin: ['seriouszyx'],
      id: md5(window.location.pathname),
      distractionFreeMode: false,
      createIssueManually: true,
      pagerDirection: 'first',
      perPage: 25,
    })

    gitalk.render('gitalk-container')
  </script>

<script>
  var Star = window.Star || {};
  var CONFIG = {
    fancybox: true,
    tocbot: true
  };
  window.CONFIG = CONFIG;
</script>
<script src="/js/utils.js"></script>
<script src="/js/star.js"></script>

</body>
</html>
