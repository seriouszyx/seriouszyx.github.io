













<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>🛡️【攻击检测】网络扫描探测工具的分析与识别 [ 隐秀 ]</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-one-light.min.css">
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  

  <link rel="stylesheet" href="/css/third_party/utilities.min.css">
  <link rel="stylesheet" href="/css/star.css">
<meta name="generator" content="Hexo 6.1.0"></head>
<body>

<main class="page-content" aria-label="Content">
  

  <div class="wrapper">
    
    
  <article 
    class="post h-entry"
    id="post"
    itemscope
    itemtype="http://schema.org/BlogPosting"
  >

  <header class="post-header">
    <div class="post-back">
      <a class="black-link" href="/">
        ← Home
      </a>
    </div>

    <h1 class="post-title p-name" itemprop="name headline">
      🛡️【攻击检测】网络扫描探测工具的分析与识别
    </h1>
    <p class="post-meta">
      <time
        class="dt-published"
        datetime="1630477824000"
        itemprop="datePublished"
      >
        Sep 01, 2021
      </time>•
      <span itemprop="author" itemscope itemtype="http://schema.org/Person"
        ><span class="p-author h-card" itemprop="name"
          >seriouszyx</span
        ></span
      >
        <span class="busuanzi_container_page">
          <span id="busuanzi_container_page_pv">
            •
          <span id="busuanzi_value_page_pv"></span> View
          </span>
        </span>
      
    </p>
  </header>

  <div class="js-toc"></div>

  <div class="post-content" itemprop="articleBody">
    <h2 id="扫描探测工具识别"><a href="#扫描探测工具识别" class="headerlink" title="扫描探测工具识别"></a>扫描探测工具识别</h2><p>网络扫描探测通常是发起网络入侵的第一步，攻击者可以利用扫描探测工具获取网络中的主机系统、TCP/UDP 端口的开放情况、子域名、网站指纹、WAF、CDN、中间件类别等重要信息，识别出存在安全漏洞的主机或系统，从而发起有针对性的网络入侵行为。此外，一些扫描工具同时具备漏洞利用的能力。因此，对网络扫描探测行为进行识别和研究，有利于及时发现网络攻击的前兆，发现网络攻击行为，快速定位网络服务中存在的漏洞，对网络安全防护工作十分有意义。</p>
<p>本文以下列三个常见扫描器为代表，探究扫描器的特有指纹信息，编写 Demo 进行扫描器的识别。</p>
<p><img src="https://img.seriouszyx.com/202109011044955.png#vwid=1999&amp;vhei=694"></p>
<h2 id="Zmap"><a href="#Zmap" class="headerlink" title="Zmap"></a>Zmap</h2><h3 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h3><p>ZMap 被设计用来针对整个 IPv4 地址空间或其中的大部分实施综合扫描的工具。</p>
<p>默认情况下，ZMap 会对于指定端口实施尽可能大速率的 TCP SYN 扫描。如下图所示，客户端在发送一个 SYN 包的时候，如果对方端口开放，就会发送一个 SYN-ACK，那么就表明这个端口开放，这时候我们发送 RST 包，防止占用对方资源；如果对方端口不开放，那么我们就会收到对方主机的 RST 包。</p>
<p><img src="https://img.seriouszyx.com/202109011044047.png#vwid=2652&amp;vhei=1128"></p>
<p>较为保守的情况下，对 10,000 个随机的地址的 80 端口以 10Mbps 的速度扫描，如下所示：</p>
<p><img src="https://img.seriouszyx.com/202109011044067.png#vwid=2225&amp;vhei=653"></p>
<p>在生成的 csv 结果文件中，以下 IP 地址的 80 端口开放：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">47.243</span>.139.246
<span class="token number">20.205</span>.204.152
<span class="token number">121.36</span>.193.65
<span class="token number">156.245</span>.39.71
<span class="token number">13.238</span>.233.150
<span class="token number">142.234</span>.31.240
<span class="token number">68.183</span>.75.244
<span class="token number">185.48</span>.122.237
<span class="token number">52.25</span>.116.123
<span class="token number">104.127</span>.1.181
<span class="token number">185.248</span>.102.245
<span class="token number">95.217</span>.201.8
<span class="token number">3.125</span>.24.134
<span class="token number">23.15</span>.117.202<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>抓包结果如下所示，Zmap 向随机的 10,000 个 IP 的 80 端口发送 SYN 数据包。</p>
<p><img src="https://img.seriouszyx.com/202109011044558.png#vwid=2560&amp;vhei=908"></p>
<p>如果 IP 的 80 端口开放，以 47.243.139.246 为例，筛选出的数据包如下图所示，具体解释为：</p>
<ol>
<li>向 47.243.139.246 的 80 端口发送 SYN 数据包</li>
<li>接收到 47.243.139.246 的 80 端口的 SYN/ACK 包，证明该 IP 的 80 端口可用</li>
<li>向 47.243.139.246 的 80 端口发送 RST 数据包，防止占用对方资源</li>
</ol>
<p><img src="https://img.seriouszyx.com/202109011044591.png#vwid=2560&amp;vhei=371"></p>
<p>如果 IP 的 80 端口不开放，以 44.102.170.124 为例，筛选出的数据包如下图所示。Zmap 向其发送 SYN 请求后没有得到应答，故判断该 IP 的 80 端口不可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044623.png#vwid=2560&amp;vhei=235"></p>
<p>查看 Zmap 向哪些 IP 发送了 RST 数据包，则证明这些 IP 的 80 端口可用。筛选结果如下图所示，目的地址与上述的 csv 结果文件一致。</p>
<p><img src="https://img.seriouszyx.com/202109011044663.png#vwid=2560&amp;vhei=798"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>Zmap 整体函数调用图如下所示。</p>
<p><img src="https://img.seriouszyx.com/202109011044692.png#vwid=942&amp;vhei=522"></p>
<p>通过图我们可以直观的看到整个程序调用的过程。Zmap 在启动时候，先获取环境信息，如 IP、网关等。然后读取配置文件选择使用哪种扫描方式，然后在 Probe_modules 切换到对应的模块，然后启动。</p>
<p>下面侧重分析 SYN 扫描这个模块，整个执行的过程中，会有一个线程专门负责发送，另外有一个使用 libpcap 组件抓包，发送和接收就独立开来。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zmap/zmap/blob/main/src/probe_modules/module_tcp_synscan.c">zmap/src/probe_modules/module_tcp_synscan.c</a> 是用于执行 TCP SYN 扫描的探测模块，在初始化阶段的 synscan_init_perthread 函数中，依次调用 make_ip_header 函数和 make_tcp_header 函数进行数据包 header 的封装。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">synscan_init_perthread</span><span class="token punctuation">(</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">macaddr_t</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token class-name">macaddr_t</span> <span class="token operator">*</span>gw<span class="token punctuation">,</span>
    <span class="token class-name">port_h_t</span> dst_port<span class="token punctuation">,</span>
    UNUSED <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>arg_ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ether_header</span> <span class="token operator">*</span>eth_header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ether_header</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
    <span class="token function">make_eth_header</span><span class="token punctuation">(</span>eth_header<span class="token punctuation">,</span> src<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>eth_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> ZMAP_TCP_SYNSCAN_TCP_HEADER_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">make_ip_header</span><span class="token punctuation">(</span>ip_header<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcphdr</span> <span class="token operator">*</span>tcp_header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcphdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">make_tcp_header</span><span class="token punctuation">(</span>tcp_header<span class="token punctuation">,</span> dst_port<span class="token punctuation">,</span> TH_SYN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_mss_option</span><span class="token punctuation">(</span>tcp_header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这两个函数编写于 <a target="_blank" rel="noopener" href="https://github.com/zmap/zmap/blob/main/src/probe_modules/packet.c">zmap/src/probe_modules/packet.c</a> 中。分析 make_ip_header 函数可知，在下示第 7 行，IP 的 identification number 被设置为固定的 54321。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">make_ip_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>iph<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> protocol<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    iph<span class="token operator">-&gt;</span>ip_hl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// Internet Header Length</span>
    iph<span class="token operator">-&gt;</span>ip_v <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>   <span class="token comment">// IPv4</span>
    iph<span class="token operator">-&gt;</span>ip_tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Type of Service</span>
    iph<span class="token operator">-&gt;</span>ip_len <span class="token operator">=</span> len<span class="token punctuation">;</span>
    iph<span class="token operator">-&gt;</span>ip_id <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">54321</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// identification number</span>
    iph<span class="token operator">-&gt;</span>ip_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	   <span class="token comment">// fragmentation flag</span>
    iph<span class="token operator">-&gt;</span>ip_ttl <span class="token operator">=</span> MAXTTL<span class="token punctuation">;</span>      <span class="token comment">// time to live (TTL)</span>
    iph<span class="token operator">-&gt;</span>ip_p <span class="token operator">=</span> protocol<span class="token punctuation">;</span>      <span class="token comment">// upper layer protocol =&gt; TCP</span>
    <span class="token comment">// we set the checksum = 0 for now because that's</span>
    <span class="token comment">// what it needs to be when we run the IP checksum</span>
    iph<span class="token operator">-&gt;</span>ip_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分析 make_tcp_header 函数可知，在下示第 10 行，TCP 的 window 被设置为固定的 65535。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">make_tcp_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcphdr</span> <span class="token operator">*</span>tcp_header<span class="token punctuation">,</span> <span class="token class-name">port_h_t</span> dest_port<span class="token punctuation">,</span>
		     <span class="token class-name">uint16_t</span> th_flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    tcp_header<span class="token operator">-&gt;</span>th_seq <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_x2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_off <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// data offset</span>
    tcp_header<span class="token operator">-&gt;</span>th_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_flags <span class="token operator">|=</span> th_flags<span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_win <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// largest possible window</span>
    tcp_header<span class="token operator">-&gt;</span>th_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_urp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tcp_header<span class="token operator">-&gt;</span>th_dport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>dest_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看抓取的 SYN 数据包，如下图所示，IP 的 ID 和 TCP 的 window 确实为 54321 和 65535，所以这两个固定值可作为扫描器特征。</p>
<p><img src="https://img.seriouszyx.com/202109011044714.png#vwid=2560&amp;vhei=1275"></p>
<h2 id="Angry-IP-Scanner"><a href="#Angry-IP-Scanner" class="headerlink" title="Angry IP Scanner"></a>Angry IP Scanner</h2><h3 id="抓包分析-1"><a href="#抓包分析-1" class="headerlink" title="抓包分析"></a>抓包分析</h3><p>Angry IP Scanner（简称 angryip） 是一款开源跨平台的网络扫描器，主要用于扫描 IP 地址和端口。</p>
<p>angryip 默认使用 Windows ICMP 方法扫描各个 ip 地址，扫描每个 IP 的 80、443 和 8080 端口。以 IP 范围 123.56.104.200~123.56.104.250 为例，扫描结果如下图所示，红色代表 IP 不可用，蓝色代表 IP 可用端口不可用，绿色代表 IP 和端口均可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044740.png#vwid=2558&amp;vhei=1534"></p>
<p>在捕获的数据包中，以 123.56.104.218 为例，该 IP 被标记为绿色，下面是与它有关的数据包抓取结果。</p>
<p>图中第一个红框处 angryip 与 123.56.104.218 进行了 3 次 ping，且都予以回复，说明该 IP 可用。第二个红框处 angryip 分别测试 123.56.104.218 的 80、443 和 8080 端口，其中 80 和 443 端口予以回复，说明这两个端口可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044760.png#vwid=2560&amp;vhei=930"></p>
<p>在不可用的 IP 中，以 123.56.104.204 为例，与它相关的数据包抓取结果如下。angryip 向其发送 3 次 ping 请求，都没有得到回复，则判断其 IP 不可用，也没有向其端口发送数据包。</p>
<p><img src="https://img.seriouszyx.com/202109011044783.png#vwid=2560&amp;vhei=325"></p>
<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><p>因为无论 IP 和端口是否可用，angryip 都会先发送 ping 数据包，所以通过 ping 阶段的源码分析其工具的特征。</p>
<p>分析 <a target="_blank" rel="noopener" href="https://github.com/angryip/ipscan/blob/64ec7090acdba380a62d5d2e1a6c630cc5302197/test/net/azib/ipscan/core/net/ICMPSharedPingerTest.java">ipscan/test/net/azib/ipscan/core/net/ICMPSharedPingerTest.java</a> 源码，该测试类调用 pinger.ping () 方法 3 次，并计算平均时长。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ICMPSharedPingerTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span> <span class="token annotation punctuation">@Ignore</span><span class="token punctuation">(</span><span class="token string">"this test works only under root"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token class-name">Pinger</span> pinger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ICMPSharedPinger</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">PingResult</span> result <span class="token operator">=</span> pinger<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanningSubject</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAverageTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAverageTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该方法在 <a target="_blank" rel="noopener" href="https://github.com/angryip/ipscan/blob/master/src/net/azib/ipscan/core/net/WindowsPinger.java">ipscan/test/net/azib/ipscan/core/net/WindowsPinger.java</a> 中，源码如下所示，判断 IP 类型，并调用 IPv6 和 IPv4 对应的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PingResult</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token class-name">ScanningSubject</span> subject<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subject<span class="token punctuation">.</span><span class="token function">isIPv6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">ping6</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
	<span class="token keyword">return</span> <span class="token function">ping4</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以 IPv4 为例，方法中定义了数据包的数据大小为 32，即 sendDataSize = 32。后续使用 Memory () 方法创建 SendData 对象，并未对其进行赋值，故默认值应全为 0。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">PingResult</span> <span class="token function">ping4</span><span class="token punctuation">(</span><span class="token class-name">ScanningSubject</span> subject<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Pointer</span> handle <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">dll<span class="token punctuation">.</span></span>IcmpCreateFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Unable to create Windows native ICMP handle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sendDataSize <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> replyDataSize <span class="token operator">=</span> sendDataSize <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IcmpEchoReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token class-name">Pointer</span> sendData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memory</span><span class="token punctuation">(</span>sendDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>sendDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Pointer</span> replyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memory</span><span class="token punctuation">(</span>replyDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">PingResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PingResult</span><span class="token punctuation">(</span>subject<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token class-name">IpAddrByVal</span> ipaddr <span class="token operator">=</span> <span class="token function">toIpAddr</span><span class="token punctuation">(</span>subject<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> count <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> numReplies <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">dll<span class="token punctuation">.</span></span>IcmpSendEcho</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> ipaddr<span class="token punctuation">,</span> sendData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> sendDataSize<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> replyData<span class="token punctuation">,</span> replyDataSize<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">IcmpEchoReply</span> echoReply <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IcmpEchoReply</span><span class="token punctuation">(</span>replyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>numReplies <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> echoReply<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>echoReply<span class="token punctuation">.</span>address<span class="token punctuation">.</span>bytes<span class="token punctuation">,</span> ipaddr<span class="token punctuation">.</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token punctuation">.</span><span class="token function">addReply</span><span class="token punctuation">(</span>echoReply<span class="token punctuation">.</span>roundTripTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">setTTL</span><span class="token punctuation">(</span>echoReply<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ttl <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	<span class="token class-name"><span class="token namespace">dll<span class="token punctuation">.</span></span>IcmpCloseHandle</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在实际抓包中，每个发出的 ICMP 请求中，Data 的大小均为 32 字节，且全为 0，所以可将它作为 angryip 的特征。</p>
<p><img src="https://img.seriouszyx.com/202109011044806.png#vwid=2560&amp;vhei=1068"></p>
<h2 id="Masscan"><a href="#Masscan" class="headerlink" title="Masscan"></a>Masscan</h2><h3 id="抓包分析-2"><a href="#抓包分析-2" class="headerlink" title="抓包分析"></a>抓包分析</h3><p>Masscan 默认使用 SYN 扫描，以 IP 123.56.104.218 为例，扫描其 1~600 端口，结果如下所示。</p>
<p><img src="https://img.seriouszyx.com/202109011044826.png#vwid=1346&amp;vhei=278"></p>
<p>抓包结果如下所示，Masscan 向 123.56.104.218 的 1~600 端口进行随机化扫描，发出 SYN 请求。</p>
<p><img src="https://img.seriouszyx.com/202109011044847.png#vwid=2560&amp;vhei=1250"></p>
<p> 查看 80 端口的数据包，下图可知 80 端口向 Masscan 回复，说明该端口可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044871.png#vwid=2560&amp;vhei=277"></p>
<p>查看 81 端口的数据包，发现并没有数据包回复，说明该端口不可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044891.png#vwid=2560&amp;vhei=162"></p>
<p>筛选收到的 SYN/ACK 数据包，得到 22、443 和 80 端口，说明 123.56.104.218 的 1~600 中这 3 个端口可用。</p>
<p><img src="https://img.seriouszyx.com/202109011044912.png#vwid=2560&amp;vhei=260"></p>
<h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><p>观察抓包分析中结果可以发现，所有发出的 SYN 请求中，窗口大小都是 1024。</p>
<p><img src="https://img.seriouszyx.com/202109011044935.png#vwid=2560&amp;vhei=1250"></p>
<p>在 Masscan 的主函数 <a target="_blank" rel="noopener" href="https://github.com/robertdavidgraham/masscan/blob/master/src/main.c">masscan/src/main.c</a> 文件中，默认使用以下代码初始化 TCP 数据包的模板。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">template_packet_init</span><span class="token punctuation">(</span>
    parms<span class="token operator">-&gt;</span>tmplset<span class="token punctuation">,</span>
    parms<span class="token operator">-&gt;</span>source_mac<span class="token punctuation">,</span>
    parms<span class="token operator">-&gt;</span>router_mac_ipv4<span class="token punctuation">,</span>
    parms<span class="token operator">-&gt;</span>router_mac_ipv6<span class="token punctuation">,</span>
    masscan<span class="token operator">-&gt;</span>payloads<span class="token punctuation">.</span>udp<span class="token punctuation">,</span>
    masscan<span class="token operator">-&gt;</span>payloads<span class="token punctuation">.</span>oproto<span class="token punctuation">,</span>
    <span class="token function">stack_if_datalink</span><span class="token punctuation">(</span>masscan<span class="token operator">-&gt;</span>nic<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>adapter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    masscan<span class="token operator">-&gt;</span>seed<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数位于 <a target="_blank" rel="noopener" href="https://github.com/robertdavidgraham/masscan/blob/master/src/templ-pkt.c">masscan/src/templ.pkt.c</a> 中，其中对于 TCP 的初始化代码如下所示。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* [TCP] */</span>
<span class="token function">_template_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>templset<span class="token operator">-&gt;</span>pkts<span class="token punctuation">[</span>Proto_TCP<span class="token punctuation">]</span><span class="token punctuation">,</span>
               source_mac<span class="token punctuation">,</span> router_mac_ipv4<span class="token punctuation">,</span> router_mac_ipv6<span class="token punctuation">,</span>
               default_tcp_template<span class="token punctuation">,</span>
               <span class="token keyword">sizeof</span><span class="token punctuation">(</span>default_tcp_template<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
               data_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
templset<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中调用的 default_tcp_template 定义在该文件头部，下述 7 行指定 IP 的 length 为 40，下述 10 行指定 TLL 为 255，下述 18 行指定 ack 为 0，下述 21 行指定 window 的大小为 1024，可以将这些指标视为 Masscan 的特征。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> default_tcp_template<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token string">"\0\1\2\3\4\5"</span>  <span class="token comment">/* Ethernet: destination */</span>
    <span class="token string">"\6\7\x8\x9\xa\xb"</span>  <span class="token comment">/* Ethernet: source */</span>
    <span class="token string">"\x08\x00"</span>      <span class="token comment">/* Ethernet type: IPv4 */</span>
    <span class="token string">"\x45"</span>          <span class="token comment">/* IP type */</span>
    <span class="token string">"\x00"</span>
    <span class="token string">"\x00\x28"</span>      <span class="token comment">/* total length = 40 bytes */</span>
    <span class="token string">"\x00\x00"</span>      <span class="token comment">/* identification */</span>
    <span class="token string">"\x00\x00"</span>      <span class="token comment">/* fragmentation flags */</span>
    <span class="token string">"\xFF\x06"</span>      <span class="token comment">/* TTL=255, proto=TCP */</span>
    <span class="token string">"\xFF\xFF"</span>      <span class="token comment">/* checksum */</span>
    <span class="token string">"\0\0\0\0"</span>      <span class="token comment">/* source address */</span>
    <span class="token string">"\0\0\0\0"</span>      <span class="token comment">/* destination address */</span>

    <span class="token string">"\0\0"</span>          <span class="token comment">/* source port */</span>
    <span class="token string">"\0\0"</span>          <span class="token comment">/* destination port */</span>
    <span class="token string">"\0\0\0\0"</span>      <span class="token comment">/* sequence number */</span>
    <span class="token string">"\0\0\0\0"</span>      <span class="token comment">/* ack number */</span>
    <span class="token string">"\x50"</span>          <span class="token comment">/* header length */</span>
    <span class="token string">"\x02"</span>          <span class="token comment">/* SYN */</span>
    <span class="token string">"\x04\x0"</span>        <span class="token comment">/* window fixed to 1024 */</span>
    <span class="token string">"\xFF\xFF"</span>      <span class="token comment">/* checksum */</span>
    <span class="token string">"\x00\x00"</span>      <span class="token comment">/* urgent pointer */</span>
    <span class="token string">"\x02\x04\x05\xb4"</span>  <span class="token comment">/* added options [mss 1460] */</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Demo-设计与实现"><a href="#Demo-设计与实现" class="headerlink" title="Demo 设计与实现"></a>Demo 设计与实现</h2><p>经过抓包分析和源码分析后，可以总结三个扫描器的特征如下表所示。</p>
<p><img src="https://img.seriouszyx.com/202109011044988.png#vwid=1524&amp;vhei=877"></p>
<p>总体来看，三个扫描器工具都是基于单包的头部信息进行识别，且经过源码确认，属于强特征。那么识别的具体设计也就很容易了，对 pcap 文件的每个数据包进行分类，判断其是否满足上述三个指纹，核心识别流程图如下图所示。</p>
<p><img src="https://img.seriouszyx.com/202109011044015.png#vwid=622&amp;vhei=624"></p>
<p>具体实现使用 Python 的 Scrapy 包解析 pcap，进行相关操作，代码很短，核心部分如下。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> data <span class="token keyword">in</span> packets<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'TCP'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token comment"># 识别 Zmap</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'TCP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token number">65535</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'IP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">54321</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            isZmap <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 识别 Masscan</span>
        <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'TCP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token number">1024</span> <span class="token keyword">and</span> data<span class="token punctuation">[</span><span class="token string">'TCP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ack <span class="token operator">==</span> <span class="token number">0</span> \
                <span class="token keyword">and</span> data<span class="token punctuation">[</span><span class="token string">'IP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ttl <span class="token operator">==</span> <span class="token number">255</span> <span class="token keyword">and</span> data<span class="token punctuation">[</span><span class="token string">'IP'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">==</span> <span class="token number">40</span><span class="token punctuation">:</span>
            isMasscan <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token comment"># 识别 Angry IP Scanner</span>
    <span class="token keyword">if</span> <span class="token string">'ICMP'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'Raw'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            items <span class="token operator">=</span> processStr<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'Raw'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>load<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'Raw'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">32</span> <span class="token keyword">and</span> items <span class="token operator">==</span> ANGRYIP_FLAG<span class="token punctuation">:</span>
                isAngryip <span class="token operator">=</span> <span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码放置于 <a target="_blank" rel="noopener" href="https://github.com/seriouszyx/ScannerRecognition">GitHub</a>。</p>
<hr>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://linux.cn/article-5860-1.html">互联网扫描器 ZMap 完全手册</a></p>
<p><a target="_blank" rel="noopener" href="https://nanshihui.github.io/2017/03/29/zmap%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8Bzmap%E6%89%AB%E6%8F%8F%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0/">zmap 源码解读之 zmap 扫描快的原因</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/al0ne/Nmap_Bypass_IDS">Nmap_Bypass_IDS</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44288604/article/details/115656891">入侵检测 ——masscan (扫描篇)</a></p>

  </div>
  </article>

  <div id="paginator">
    
  </div>

  </div>

</main>

<footer class="site-footer h-card">
  
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name"><a class="black-link" href="/">
                seriouszyx 
              </a></li></ul>
      </div>
    </div>
  </div>
  
    <div class="text-center">
      
        <span class="text-gray-300 text-sm" id="busuanzi_container_site_pv">
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
      
      
        <span class="text-gray-300 text-sm">•</span>
      
      
          <span class="text-gray-300 text-sm" id="busuanzi_container_site_uv">
            本站访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
      
    </div>
  
  
    <div class="text-center">
      <a class="text-gray-300 text-sm" target="_blank" rel="noopener" href="https://beian.miit.gov.cn">辽ICP备19014015号</a>
    </div>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


  <script async src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js">
</script>


  <script src="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.min.js"></script>

<script>
  var Star = window.Star || {};
  var CONFIG = {
    fancybox: true,
    tocbot: true
  };
  window.CONFIG = CONFIG;
</script>
<script src="/js/utils.js"></script>
<script src="/js/star.js"></script>

</body>
</html>
